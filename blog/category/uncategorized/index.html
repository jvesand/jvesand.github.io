

<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Blogofile Example</title>
  <meta name="description" content="Just a simple HTML5 blog">
  <meta name="author" content="Your Name">
  <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/blog/feed" />
  <link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="/blog/feed/atom" />
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

  <link rel="stylesheet" href="/css/base.css?v=1">
  <link rel="stylesheet" href="/css/grid.css?v=1">
  <link rel="stylesheet" media="handheld" href="/css/handheld.css?v=1">
  <link rel="stylesheet" href="/css/pygments_murphy.css" type="text/css" />

  <script src="/js/libs/modernizr-1.7.min.js"></script>

  <link rel="stylesheet" href="/themes/theme1/style.css?v=1">
<link href='http://fonts.googleapis.com/css?family=Architects+Daughter'  rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>


</head>
  <body>
    <div id="container" class="container container_12">
      <div id="main" role="main">
        <div id="main_block">
          <header>
  <div id="header" class="header_gradient theme_font">
    <h1><a href="/">My Blogofile Example</a></h1>
    <h2>Just a simple HTML5 blog</h2>
  </div>
  <div id="navigation" class="grid_12">

    <ul class="theme_font">
      <li><a href="/"
             class="">Home</a></li>
      <li><a href="/blog"
             class="">Blog</a></li>
      <li><a href="/blog/archive"
             class="">Archives</a></li>
    </ul>
  </div>
</header>

          <div id="prose_block" class="grid_8">
            
  



<article>
  <div class="blog_post">
    <header>
      <div id="hide-properties-drawer-and-footnotes"></div>
      <h2 class="blog_post_title"><a href="/blog/2014/04/27/hide-properties-drawer-and-footnotes" rel="bookmark" title="Permanent Link to Hide PROPERTIES drawer and footnotes">Hide PROPERTIES drawer and footnotes</a></h2>
      <p><small><span class="blog_post_date">April 27, 2014 at 10:54 PM</span> | categories: 
        <span class="blog_post_categories"><a href='/blog/category/uncategorized'>uncategorized</a></span>
      </small></p>
    </header>
    <div class="post_prose">
      



<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Re-hide all drawers, footnotes or html blocks after a visibility state change</a></li>
<li><a href="#sec-2">2. Local org-cycling action (for drawers and footnotes)</a></li>
<li><a href="#sec-3">3. Regexp for regions to flag for invisibility (called on state change)</a></li>
<li><a href="#sec-4">4. Regexp for regions to flag for invisibility (called manually)</a></li>
<li><a href="#sec-5">5. Toggle visibility of footnotes on a line</a></li>
<li><a href="#sec-6">6. Python: regexp for regions to flag for invisibility</a></li>
<li><a href="#sec-7">7. Python: toggle visibility of ALL (in a block) footnotes</a></li>
</ul>
</div>
</div>

<p>
Combination of lawlist's answers from stackoverflow: <a href="http://stackoverflow.com/questions/15258055/in-org-mode-how-to-fold-hide-footnotes/21594242#21594242">hiding footnotes</a> and <a href="http://stackoverflow.com/questions/17478260/completely-hide-the-properties-drawer-in-org-mode">hiding properties drawer</a> . Modified to fit my needs.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Re-hide all drawers, footnotes or html blocks after a visibility state change</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defalias</span> '<span style="color: #268bd2;">org-cycle-hide-drawers</span> 'lawlist-block-org-cycle-hide-drawers)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">lawlist-block-org-cycle-hide-drawers</span> (state)
  <span style="color: #2aa198;">"Re-hide all drawers, footnotes or html blocks after a visibility state change."</span>
  (<span style="color: #859900; font-weight: bold;">when</span>
    (and
      (derived-mode-p 'org-mode)
      (not (memq state '(overview folded contents))))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="color: #859900; font-weight: bold;">let*</span> (
          (globalp (memq state '(contents all)))
          (beg (<span style="color: #859900; font-weight: bold;">if</span> globalp (point-min) (point)))
          (end
            (<span style="color: #859900; font-weight: bold;">cond</span>
              (globalp
                (point-max))
              ((eq state 'children)
                (<span style="color: #859900; font-weight: bold;">save-excursion</span> (outline-next-heading) (point)))
              (t (org-end-of-subtree t)) )))
        (goto-char beg)

        <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">Re-hide footnotes. This messes with properties drawer.</span>
        <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">If it finds a footnote it doesn't hide the drawer.</span>
        <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">Also, truncates footnotes if several on same line.</span>
        (<span style="color: #859900; font-weight: bold;">while</span>
          (re-search-forward
<span style="color: #9a5662;">;            </span><span style="color: #9a5662;">".*\\[fn\\|^\\#\\+BEGIN_HTML.*$\\|^[ \t]*:PROPERTIES:[ \t]*$" end t)</span>
            <span style="color: #2aa198;">".*\\[fn</span><span style="color: #859900; font-weight: bold;">\\</span><span style="color: #b58900; font-weight: bold;">|</span><span style="color: #2aa198;">^\\#\\+BEGIN_HTML.*$</span><span style="color: #859900; font-weight: bold;">\\</span><span style="color: #b58900; font-weight: bold;">|</span><span style="color: #2aa198;">^\\*\\*.*$"</span> end t)
          (lawlist-org-flag t))
        ))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Local org-cycling action (for drawers and footnotes)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="unclear">unclear</span>&#xa0;<span class="deactivated">deactivated</span></span></h2>
<div class="outline-text-2" id="text-2">

<p>
Try this out. That is, without cycling of properties and footnotes?
</p>

<p>
(defalias 'org-cycle-internal-local 'lawlist-block-org-cycle-internal-local)
</p>

<p>
(defun lawlist-block-org-cycle-internal-local ()
  "Do the local cycling action."
  (let ((goal-column 0) eoh eol eos has-children children-skipped struct)
    (save-excursion
      (if (org-at-item-p)
        (progn
          (beginning-of-line)
          (setq struct (org-list-struct))
          (setq eoh (point-at-eol))
          (setq eos (org-list-get-item-end-before-blank (point) struct))
          (setq has-children (org-list-has-child-p (point) struct)))
        (org-back-to-heading)
        (setq eoh (save-excursion (outline-end-of-heading) (point)))
        (setq eos (save-excursion (1- (org-end-of-subtree t t))))
        (setq has-children
          (or
            (save-excursion
              (let ((level (funcall outline-level)))
                (outline-next-heading)
                (and
                  (org-at-heading-p t)
                  (&gt; (funcall outline-level) level))))
            (save-excursion
              (org-list-search-forward (org-item-beginning-re) eos t)))))
      (beginning-of-line 2)
      (if (featurep 'xemacs)
        (while
            (and
              (not (eobp))
              (get-char-property (1- (point)) 'invisible))
          (beginning-of-line 2))
        (while
            (and
              (not (eobp))
              (get-char-property (1- (point)) 'invisible))
          (goto-char (next-single-char-property-change (point) 'invisible))
          (and
            (eolp)
            (beginning-of-line 2))))
      (setq eol (point)))
    (cond
      ((= eos eoh)
        (unless (org-before-first-heading-p)
          (run-hook-with-args 'org-pre-cycle-hook 'empty))
        (org-unlogged-message "EMPTY ENTRY")
        (setq org-cycle-subtree-status nil)
        (save-excursion
          (goto-char eos)
          (outline-next-heading)
          (if (outline-invisible-p)
            (org-flag-heading nil))))
      ((and
          (or
            (&gt;= eol eos)
            (not (string-match "\&sect;-" (buffer-substring eol eos))))
          (or
            has-children
            (not (setq children-skipped
              org-cycle-skip-children-state-if-no-children))))
        (unless (org-before-first-heading-p)
          (run-hook-with-args 'org-pre-cycle-hook 'children))
        (if (org-at-item-p)
          ;; then
          (org-list-set-item-visibility (point-at-bol) struct 'children)
          ;; else
          (org-show-entry)
          (org-with-limited-levels (show-children))
          (when (eq org-cycle-include-plain-lists 'integrate)
            (save-excursion
              (org-back-to-heading)
              (while (org-list-search-forward (org-item-beginning-re) eos t)
                (beginning-of-line 1)
                (let* (
                    (struct (org-list-struct))
                    (prevs (org-list-prevs-alist struct))
                    (end (org-list-get-bottom-point struct)))
                  (mapc (lambda (e) (org-list-set-item-visibility e struct 'folded))
                    (org-list-get-all-items (point) struct prevs))
                  (goto-char (if (&lt; end eos) end eos)))))))
        (org-unlogged-message "CHILDREN")
        (save-excursion
          (goto-char eos)
          (outline-next-heading)
          (if (outline-invisible-p)
            (org-flag-heading nil)))
        (setq org-cycle-subtree-status 'children)
        (unless (org-before-first-heading-p)
          (run-hook-with-args 'org-cycle-hook 'children)))
      ((or
          children-skipped
          (and
            (eq last-command this-command)
            (eq org-cycle-subtree-status 'children)))
        (unless (org-before-first-heading-p)
          (run-hook-with-args 'org-pre-cycle-hook 'subtree))
        (outline-flag-region eoh eos nil)
        (org-unlogged-message
        (if children-skipped
          "SUBTREE (NO CHILDREN)"
          "SUBTREE"))
        (setq org-cycle-subtree-status 'subtree)
        (unless (org-before-first-heading-p)
          (run-hook-with-args 'org-cycle-hook 'subtree)))
      ((eq org-cycle-subtree-status 'subtree)
        (org-show-subtree)
        (message "ALL")
        (setq org-cycle-subtree-status 'all))
      (t
        (run-hook-with-args 'org-pre-cycle-hook 'folded)
        (outline-flag-region eoh eos t)
        (org-unlogged-message "FOLDED")
        (setq org-cycle-subtree-status 'folded)
        (unless (org-before-first-heading-p)
        (run-hook-with-args 'org-cycle-hook 'folded))))))
#+END_SRC
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> <span class="todo TODO">TODO</span> Regexp for regions to flag for invisibility (called on state change)</h2>
<div class="outline-text-2" id="text-3">

<p>
From lawlist:
Instead of moving forward one character at a time (forward-char 1), you may wish to consider going to the end of the line and using re-search-backward.  If you have a hit with re-search-backward, you are already looking your beginning footnote regexp.  That way the code only stops to evaluate whether to hide / unhide the footnote as many times as the footnotes appear.  The way you have written it with (forward-char 1), the evaluation occurs once every character &#x2013; i.e., if the line has 200 characters, the code will be evaluated 200 times.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">lawlist-org-flag</span> (flag)
  <span style="color: #2aa198;">"When FLAG is non-nil, hide any of the following:  html code block;</span>
<span style="color: #2aa198;">footnote; or, the properties drawer.  Otherwise make it visible."</span>
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (beginning-of-line 1)
    (<span style="color: #859900; font-weight: bold;">cond</span>
     ((looking-at <span style="color: #2aa198;">"^\\*\\*.*$"</span>)
      (<span style="color: #859900; font-weight: bold;">let*</span> ((begin (match-end 0)))
        (<span style="color: #859900; font-weight: bold;">if</span> (re-search-forward
             <span style="color: #2aa198;">"^[ \t]*:END:"</span>
             (<span style="color: #859900; font-weight: bold;">save-excursion</span> (outline-next-heading) (point)) t)
            (outline-flag-region begin (point-at-eol) flag)
          <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">Since I check every single node with atleast two asteriks, remove:</span>
          <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">(user-error ":END: line missing at position %s" b)</span>
          )))
     ((looking-at <span style="color: #2aa198;">"^\\#\\+BEGIN_HTML.*$"</span>)
      (<span style="color: #859900; font-weight: bold;">let*</span> ((begin (match-end 0)))
        (<span style="color: #859900; font-weight: bold;">if</span> (re-search-forward 
             <span style="color: #2aa198;">"^\\#\\+END_HTML.*$"</span>
             (<span style="color: #859900; font-weight: bold;">save-excursion</span> (outline-next-heading) (point)) t)
            (outline-flag-region begin (point-at-eol) flag)
          (<span style="color: #cb4b16; font-weight: bold; text-decoration: underline;">user-error</span> <span style="color: #2aa198;">"Error beginning at point %s."</span> begin)))))

    (<span style="color: #859900; font-weight: bold;">while</span> (&lt; (point) (point-at-eol))
      (forward-char 1)
      (<span style="color: #859900; font-weight: bold;">cond</span>
       ((looking-at <span style="color: #2aa198;">"\\[fn::"</span>)
        (<span style="color: #859900; font-weight: bold;">let*</span> ((begin (match-end 0))
               end-footnote)
          (<span style="color: #859900; font-weight: bold;">if</span> (re-search-forward 
               <span style="color: #2aa198;">"\\]"</span>
               (<span style="color: #859900; font-weight: bold;">save-excursion</span> (outline-next-heading) (point)) t)
              (<span style="color: #859900; font-weight: bold;">progn</span>
                (setq end-footnote (point))
                (outline-flag-region begin end-footnote flag))
            (<span style="color: #cb4b16; font-weight: bold; text-decoration: underline;">user-error</span> <span style="color: #2aa198;">"Error beginning at point %s."</span> begin))))))
      ))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Regexp for regions to flag for invisibility (called manually)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="deactivated">deactivated</span></span></h2>
<div class="outline-text-2" id="text-4">

<p>
Keeping the manual control to lines for now, and that works with the normal one.
</p>

<p>
(defun lawlist-manual-org-flag (flag)
 "When FLAG is non-nil, hide any of the following: html code block;
footnote; or, the properties drawer. Otherwise make it visible."
 (save-excursion
   (cond
     ((looking-at "\\[fn::")
       (let* (
         (begin (match-end 0))
         end-footnote)
         (if (re-search-forward "\\]"
               (save-excursion (outline-next-heading) (point)) t)
           (progn
             (setq end-footnote (point))
             (outline-flag-region begin end-footnote flag))
           (user-error "Error beginning at point %s." begin))))
     ((looking-at "^\\#\\+BEGIN_HTML.*\(\\|^[ \t]*:PROPERTIES:[ \t]*\)")
       (let* ((begin (match-end 0)))
         (if (re-search-forward "^\\#\\+END_HTML.*$\\|^[ \t]*:END:"
               (save-excursion (outline-next-heading) (point)) t)
           (outline-flag-region begin (point-at-eol) flag)
           (user-error "Error beginning at point %s." begin)))))))
#+END_SRC
</p>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Toggle visibility of footnotes on a line</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">lawlist-toggle-block-visibility</span> ()
<span style="color: #2aa198;">"For this function to work, the cursor must be on the same line as the regexp."</span>
(interactive)
(<span style="color: #859900; font-weight: bold;">if</span>
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (beginning-of-line 1)
      (looking-at <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">for individual footnotes, remove .* and put manual func</span>
       <span style="color: #2aa198;">".*\\[fn::</span><span style="color: #859900; font-weight: bold;">\\</span><span style="color: #b58900; font-weight: bold;">|</span><span style="color: #2aa198;">^\\#\\+BEGIN_HTML.*$</span><span style="color: #859900; font-weight: bold;">\\</span><span style="color: #b58900; font-weight: bold;">|</span><span style="color: #2aa198;">^[ \t]*:PROPERTIES:[ \t]*$"</span>))
    (lawlist-org-flag (not (get-char-property (match-end 0) 'invisible)))
  (message <span style="color: #2aa198;">"Sorry, you are not on a line containing the beginning regexp."</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Python: regexp for regions to flag for invisibility</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">lawlist-python-org-flag</span> (flag)
  <span style="color: #2aa198;">"When FLAG is non-nil, hide any of the following:  html code block;</span>
<span style="color: #2aa198;">footnote; or, the properties drawer.  Otherwise make it visible."</span>
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (beginning-of-buffer)
    (beginning-of-line 1)
    (<span style="color: #859900; font-weight: bold;">while</span> (&lt; (point) (point-max))
      (forward-char 1)
      (<span style="color: #859900; font-weight: bold;">cond</span>
       ((looking-at <span style="color: #2aa198;">"\\[fn::"</span>)
        (<span style="color: #859900; font-weight: bold;">let*</span> ((begin (match-end 0))
               end-footnote)
          (<span style="color: #859900; font-weight: bold;">if</span> (re-search-forward 
               <span style="color: #2aa198;">"\\]"</span>
               (<span style="color: #859900; font-weight: bold;">save-excursion</span> (end-of-buffer) (point)) t)
              (<span style="color: #859900; font-weight: bold;">progn</span>
                (setq end-footnote (point))
                (outline-flag-region begin end-footnote flag))
            (<span style="color: #cb4b16; font-weight: bold; text-decoration: underline;">user-error</span> <span style="color: #2aa198;">"Error beginning at point %s."</span> begin))))))
      ))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Python: toggle visibility of ALL (in a block) footnotes</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">lawlist-toggle-python-org-block-visibility</span> ()
<span style="color: #2aa198;">"For this function to work, the cursor must be on the same line as the regexp."</span>
(interactive)
(<span style="color: #859900; font-weight: bold;">if</span>
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (beginning-of-line 1)
      (looking-at <span style="color: #9a5662;">;; </span><span style="color: #9a5662;">for individual footnotes, remove .* and put manual func</span>
       <span style="color: #2aa198;">".*\\[fn::"</span>))
    (lawlist-python-org-flag (not (get-char-property (match-end 0) 'invisible)))
  (message <span style="color: #2aa198;">"Sorry, you are not on a line containing the beginning regexp."</span>)))
</pre>
</div>
</div>
</div>


    </div>
  </div>
</article>



  <hr class="interblog" />

          </div>
          <div id="sidebar" class="grid_4">
            <aside>
  <section>
    <h1 class="post_header_gradient theme_font">Latest Posts</h1>
    <ul>
      <li><a href="/blog/2014/04/27/hide-properties-drawer-and-footnotes">Hide PROPERTIES drawer and footnotes</a></li>
      <li><a href="/blog/2014/04/27/pathology">Pathology</a></li>
    </ul>
  </section>
  <section>
    <h1 class="post_header_gradient theme_font">From Twitter "example"</h1>
    <div id="on_twitter">
      <div id="tweets"></div>
      <a href="http://search.twitter.com/search?q=example" style="float: right">See more tweets</a>
    </div>
  </section>
</aside>

          </div>
          <div class="clear"></div>
        </div>
      </div>
      
<footer>
  <div id="footer" class="grid_12">
    <div class="grid_8">
      <p>
        <a href="/blog/feed/index.xml">RSS</a>
      </p>
    </div>
    <div class="grid_4" id="credits">
      <p>
        Copyright 2014
        Your Name
      </p>
      <p>
        Powered by <a href="http://www.blogofile.com">Blogofile</a>
      </p>
    </div>
  </div>
</footer>

    </div>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/libs/jquery-1.5.1.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/plugins.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/jquery.tweet.js"></script>  
  <script src="/js/site.js"></script>
  <!--[if lt IE 7 ]>
  <script src="js/libs/dd_belatedpng.js"></script>
  <script> DD_belatedPNG.fix('img, .png_bg');</script>
  <![endif]-->
  <script>
      var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>

  </body>
</html>






